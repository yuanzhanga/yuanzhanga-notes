record.bind_status === 1 ? styles.preemption : ''
最好把不符合要求的设为‘’，这样即使这个字段不存在也不会展示多余样式

后端传来的数据前端写死，再更新接传参时也要写死

  // 使用 ref 保存最新的 fetchPackingTaskDetail后端接口，避免依赖导致的无限循环
  const fetchRef = useRef(fetchPackingTaskDetail);
  fetchRef.current = fetchPackingTaskDetail;
  useEffect(() => {
    const taskId = router.currentRoute.params?.task_id;
    if (taskId) {
      fetchRef.current(taskId);
    }
  }, [router]);
router 是 整个路由实例，里面包含 location、history、params、query...
React 每次渲染都会生成新的 router 对象（引用不同）。
于是 [router] 永远「变」，useEffect 永远重新执行 → 再次调用 fetchPackingTaskDetail → 再次触发渲染 → 再次得到新 router...
死循环形成。
用 ref 只是把「真正要调用的函数」缓存起来，不把会变的 router 放进依赖，所以循环被打破；但这也放弃了「路由参数变化自动重新请求」的能力

const { task_id: taskId } = router.currentRoute.params || {};
useEffect(() => {
    if (taskId) {
      fetchPackingTaskDetail(taskId);
    }
  }, [taskId, fetchPackingTaskDetail]);



ProForm 的 component vs render：
type: 'component' + component 函数: ProForm 会自动创建一个 Form.Item 包裹组件，并通过 value/onChange 管理值
type: 'component' + render 函数: 直接渲染，ProForm 不做额外包裹
component会自动包一层，render可以解决TimePicker.RangePicker显示bug问题


当一个弹窗内部值依赖于表格或者表单某个值，组件通信，最好在点击按钮的同时去获取表格的值，避免直接在组件名上传递静态值(使用useState依赖异步更新的state),在open里带入最新的数据


useEffect当打开弹窗时设置表单值会触发Value变化，导致 useEffect 执行重置---加一个初始化判断，如果是初始化不执行重置逻辑


一组选择框要排除已选的，遍历获取除自己行以外的所有已选，在总选择里删去已选



const [, forceUpdate] = useState({});//执行useState用于强制刷新
  const handleConfirm = () => {
    forceUpdate({}); // 强制刷新，触发有些函数重新执行
    // 手动触发字段校验，清除确认后有值但是报的错误提示
    form.validateFields(['channel_config_list']).catch(() => {});
  };


state更新时使用函数式，可能避免所使用的函数依赖本数据，导致执行一次函数依赖改变触发重新渲染

多选框选择一个后选项框隐藏，是命名了一个全局state，选择选项导致state变化，触发重新渲染导致选项框隐藏，可以声明一个子组件，选择选项框修改子组件内部的state值，不触发全局渲染，关闭选项框将内部临时值同步到外部

<template>
  <div class="m-packer-scan">
    <div class="m-input-panel">
      <div v-if="stationIdNeed" style="margin-bottom: 16px">
        <label>{{ $i18n('Station ID') }}</label>
        <s-input
          ref="statonIdInput"
          v-only-scan="{
            interval: 'PC.ManualInputPermission.StationID.Input',
            expression: 'curStationId',
          }"
          v-loading="stationIdInputLoading"
          :disabled="curStationIdChecked"
          v-model.trim="curStationId"
          @keyup.enter.native="stationIdScan"
          @input="changeToUpperCase"
        />
      </div>
      <div>
        <label>{{ $i18n('User /Staff ID') }}</label>
        <s-input
          v-if="!isWmsLoginUserAsDefaultPacker"
          ref="packerIdInput"
          v-only-scan="{
            interval: 'PC.ManualInputPermission.UserID&StaffID.Input',
            expression: 'curPackerId',
          }"
          :disabled="!curStationIdChecked"
          v-loading="inputLoading"
          v-model.trim="curPackerId"
          @keyup.enter.native="addPacker"
        />
        <s-input
          v-else
          ref="packerIdInput"
          v-only-scan="{
            interval: 'PC.ManualInputPermission.UserID&StaffID.Input',
            expression: 'curPackerId',
          }"
          disabled
          v-model.trim="curPackerId"
        />
      </div>
    </div>
    <template v-if="!isWmsLoginUserAsDefaultPacker">
    <!-- <template> -->
      <div class="m-main-container" id="main-container">
        <div class="m-table-panel" :style="{ height: tablePanelHeight }">
          <s-table
            :data="packerList"
            :scroll="{
              y: packerList.length > 4 ? '100%' : '200px',
            }"
          >
            <s-table-column :label="$i18n('Packer ID')">
              <template v-slot="scope">
                <s-tooltip
                  :content="String(scope.row.user_id || scope.row.staff_no)"
                >
                  <span>{{ scope.row.user_id || scope.row.staff_no }}</span>
                </s-tooltip>
              </template>
            </s-table-column>
            <s-table-column
              prop="email"
              :label="$i18n('Packer Name')"
              :show-overflow-tooltip="true"
            ></s-table-column>
            <s-table-column
              :label="$i18n('Action')"
              v-slot="scope"
              :width="80"
              fixed="right"
            >
              <s-button type="text" @click="removePackerItem(scope.index)">
                {{ $i18n('Delete') }}
              </s-button>
            </s-table-column>
          </s-table>
          <div class="u-packer-total">
            {{ $i18n('Total:') + ' ' + packerList.length }}
          </div>
        </div>
      </div>
      <div class="m-btns-panel">
        <s-button :disabled="packerList.length == 0" @click="reset">
          {{ $i18n('Reset') }}
        </s-button>
        <s-button
          :disabled="packerList.length == 0 || !curStationIdChecked"
          type="primary"
          @click="confirm"
          v-loading="confirmLoading"
        >
          {{ $i18n('Confirm') }}
        </s-button>
      </div>
    </template>
  </div>
</template>

<script lang="ts">
import { Vue, Component } from 'vue-property-decorator';
import {
  validatePackerUser,
  createPackerTask,
  checkStation,
  getStationSetting,
  bindStation,
  cancelPackingTask,
} from '@/api/sales-outbound/packing';
import { notificationSoundProcess } from '@/utils/notification-sound';
import { safeGet } from '@/utils/safeGet';
import { getDevConf } from '@/api/basic/displaySetting';
import { getCookie } from '@/utils/cookie';
import { RECORD_PACKING_STATION_ID } from '../constant';
import { State } from 'vuex-class';

interface PackerConfig {
  staff_no: string;
  email: string;
  user_id: number;
}

@Component
export default class PackerScan extends Vue {
  @State permission: any;
  curPackerId = '';

  packerList: PackerConfig[] = [];

  packerSet: Set<string> = new Set();

  inputLoading = false;

  // 创建的 task ID
  createdTaskId = '';

  // 当前的 station id
  curStationId = 'PS00002';

  // station 扫描 loading
  stationIdInputLoading = false;

  // 是否检查通过
  curStationIdChecked = false;

  // 是否需要扫描 station id
  stationIdNeed = true;

  // 表格高度
  tableHeight = 0;

  // 确认 loading
  confirmLoading = false;

  //worklog开关
  isWmsLoginUserAsDefaultPacker = false;
  // 用户邮箱
  userEmail = '';
  get tablePanelHeight() {
    const height = (this.packerList.length + 2) * 48;
    return height > this.tableHeight ? this.tableHeight + 'px' : height + 'px';
  }

  async mounted() {
    try {
      // 获取 station 设置
      const res = await getStationSetting();
      const list = safeGet(res, 'data.list');
      // 获取 packing 的 station 设置
      this.stationIdNeed = !!list.filter((item: any) => {
        return item.setting_key === RECORD_PACKING_STATION_ID;
      })[0]?.setting_enable;
      await this.getDevConf();
      this.userEmail = localStorage.getItem('useremail') || '';
      if (this.isWmsLoginUserAsDefaultPacker) {
        this.curPackerId = this.userEmail;
      }
      if (this.stationIdNeed) {
        this.curStationIdChecked = false;
        this.$nextTick(() => {
          (this.$refs['statonIdInput'] as HTMLInputElement).focus();
        });
      } else {
        this.curStationIdChecked = true;
        this.$nextTick(() => {
          (this.$refs['packerIdInput'] as HTMLInputElement).focus();
        });
      }
    } catch (e) {
      console.log(e);
      e;
    }
    const container = document.getElementById('main-container');
    this.tableHeight = Number(container?.clientHeight) - 88;
  }

  addPacker() {
    if (!this.curPackerId) {
      return;
    }
    this.inputLoading = true;
    validatePackerUser([this.curPackerId])
      .then((res: any) => {
        const { staff_no, email, user_id } = res.data.user_list[0];
        const newUser = JSON.stringify({
          staff_no: staff_no || null,
          email,
          user_id,
        });
        if (this.packerSet.has(newUser)) {
          this.packerSet.delete(newUser);
        }
        this.packerSet.add(newUser);
        this.packerList = Array.from(this.packerSet)
          .map((item: string) => {
            return JSON.parse(item);
          })
          .reverse();
        this.inputLoading = false;
        if (this.isWmsLoginUserAsDefaultPacker) {
          this.confirm();
        }
      })
      .catch(async (err) => {
        // 判断是否存在任务
        if (err.retcode === -233407) {
          // 存在任务
          try {
            const { staff_no, email, user_id } = err.data.user_list[0];
            const newUser = JSON.stringify({
              staff_no: staff_no || null,
              email,
              user_id,
            });
            if (this.packerSet.has(newUser)) {
              // 已经添加过，就不提示直接置顶
              this.packerSet.delete(newUser);
              this.packerSet.add(newUser);
            } else {
              // 还没添加过，提示再添加
              await (this as any).$confirm(err.message, this.$i18n('Notice'));
              this.packerSet.add(newUser);
            }
            this.packerList = Array.from(this.packerSet)
              .map((item: string) => {
                return JSON.parse(item);
              })
              .reverse();
            if (this.isWmsLoginUserAsDefaultPacker) {
              this.confirm();
            } else {
              (this.$refs['packerIdInput'] as HTMLInputElement).focus();
            }
          } catch (e) {
            this.curStationIdChecked = false;
            e;
          }
        }
        this.inputLoading = false;
      })
      .finally(() => {
        (this.$refs['packerIdInput'] as HTMLInputElement).focus();
        this.inputLoading = false;
        !this.isWmsLoginUserAsDefaultPacker && (this.curPackerId = '');
      });
  }

  async reset() {
    try {
      await (this as any).$confirm('Reset packer List?', 'Notice');
      this.packerList = [];
      this.curPackerId = '';
      this.packerSet.clear();
      (this.$refs['packerIdInput'] as HTMLInputElement).focus();
    } catch (e) {
      console.log(e);
    }
  }

  async confirm() {
    const key = this.packerList.map((item) => {
      if (item.user_id === 0) {
        return item.staff_no + '';
      } else {
        return item.user_id + '';
      }
    });
    // 判断是否存在任务
    validatePackerUser(key as string[])
      .then(() => {
        // 校验通过，直接创建任务并绑定station
        this.createTaskAndBindStation();
      })
      .catch(async (err) => {
        if (err.retcode === -233407) {
          /**
           * 存在任务需要确认再创建
           * 这里存在的 task 任务可能是上一次绑定没成功的 task，需要处理
           */
          if (this.createdTaskId && err.message.indexOf(this.createdTaskId)) {
            /**
             * 存在的话就不需要提问了，说明上一次操作绑定 station 失败
             * 重新创建，并且带上 task id
             */
            this.createTaskAndBindStation();
          } else {
            try {
              /**
               * 存在任务，但是在其他 station
               * 提示用户是否要结束其他任务来创建新的 task
               */
              await (this as any).$confirm(err.message, this.$i18n('Notice'));
              this.createTaskAndBindStation();
            } catch (e) {
              e;
            }
          }
        }
      });
  }

  async getDevConf() {
    const whs = getCookie('setting_whs_v2') || '';
    const { data } = await getDevConf({
      conf_key: 'wms_login_user_as_default_packer',
      whs_id: whs,
    });
    this.isWmsLoginUserAsDefaultPacker = data.conf_value === '1';
  }
  /**
   * 创建任务并绑定 station
   */
  createTaskAndBindStation() {
    this.confirmLoading = true;
    createPackerTask(this.packerList, this.createdTaskId || undefined)
      .then(async (res) => {
        const task_id = safeGet(res, 'data.task_id');
        const station_id = this.curStationId;
        this.createdTaskId = task_id;
        try {
          station_id && (await bindStation({ task_id, station_id }));
          // 绑定成功
          this.confirmLoading = false;
          notificationSoundProcess(
            'PC.Outbound.Sales Outbound.Packing.enter session success'
          ); //播放提示音
          this.$emit('packerConfirm', { task_id, station_id });
        } catch (bindErr) {
          /**
           * 绑定失败可能是两大种
           * 1、因为并发问题导致 station 状态为 using
           * 2、其他（网络问题）
           */
          // 因为并发问题导致 station 状态为 using
          if (bindErr.retcode === -21853) {
            // station using 状态不能用了，需要重新扫一个
            this.$message.error('Station is using, please try again.');
            this.curStationIdChecked = false;
            this.confirmLoading = false;
            this.$nextTick(() => {
              (this.$refs['statonIdInput'] as HTMLInputElement).select();
            });
          } else if (bindErr.retcode === -21852) {
            // station 被禁用
            const title = this.$i18n('Notice');
            await (this as any).$alert(bindErr.message, title, {
              showClose: false,
            });
            this.curStationIdChecked = false;
            this.confirmLoading = false;
            this.$nextTick(() => {
              (this.$refs['statonIdInput'] as HTMLInputElement).select();
            });
          } else {
            this.confirmLoading = false;
            try {
              // 递归去处理
              await (this as any).$confirm(
                'Bind Station error, please try again.',
                'Notice'
              );
              await this.createTaskAndBindStation();
            } catch (e) {
              e;
            }
          }
        }
      })
      .catch((err) => {
        err;
        this.confirmLoading = false;
      });
  }

  removePackerItem(index: number) {
    const newUser = JSON.stringify(this.packerList[index]);
    this.packerSet.delete(newUser);
    this.packerList.splice(index, 1);
  }

  changeToUpperCase() {
    this.curStationId = this.curStationId.toUpperCase();
  }

  // station 扫描
  async stationIdScan() {
    if (!this.curStationId) return;
    this.stationIdInputLoading = true;
    // 前端检测
    if (!/^PS\d{5}$/.test(this.curStationId)) {
      const title = this.$i18n('Notice');
      const msg = this.$i18n('Invalid Packing Station ID!');
      await (this as any).$alert(msg, title, { showClose: false });
      this.stationIdInputLoading = false;
      setTimeout(() => {
        (this.$refs['statonIdInput'] as HTMLInputElement).select();
      }, 200);
      return;
    }
    this.curStationIdChecked = false;
    // 检查 station 状态
    checkStation({ station_id: this.curStationId })
      .then(async (res: any) => {
        const task_id = safeGet(res, 'data.task_id');
        if (!task_id) {
          // 校验通过，并且不存在 task id，station = normal 状态
          this.curStationIdChecked = true;
          this.stationIdInputLoading = false;
          if (this.isWmsLoginUserAsDefaultPacker) {
            this.addPacker();
          } else {
            this.$nextTick(() => {
              (this.$refs['packerIdInput'] as HTMLInputElement).focus();
            });
          }
        }
      })
      .catch(async (err: any) => {
        this.stationIdInputLoading = false;
        try {
          /**
           * 存在三种错误
           * 1、不存在
           * 2、被禁用：重新扫描
           *
           * 3、被占用 using 状态：是否进入 station 的任务
           */
          if (err.retcode === -21851) {
            // 不存在
            (this.$refs['statonIdInput'] as HTMLInputElement).select();
          }
          if (err.retcode === -21853) {
            // station: status = using，被占用
            if (err.data.task_id) {
              try {
                // 如果status = using，则弹出一个窗口，显示消息“此包装站正在进行会话。恢复会话？”。
                const msg = this.$i18n(
                  'There is an ongoing session at this packing station. Resume Session?'
                );
                const title = this.$i18n('Notice');
                await (this as any).$confirm(msg, title, {
                  showClose: false,
                  confirmButtonText: this.$i18n('resume'),
                  cancelButtonText: this.$i18n('start a new session'),
                  confirmButtonClass: 'resumeConfirm',
                });
                // 确认继续会话，光标跳至“ LM Tracking No”框
                this.$emit('packerConfirm', {
                  task_id: err.data.task_id,
                  station_id: this.curStationId,
                });
              } catch (e) {
                /**
                 * 单击“开始新会话”按钮pop_up消失，光标跳到“ WMS_User_ID /职员ID”框。
                 * 需要释放掉原来的 task 和 station
                 */
                // 接口释放操作
                cancelPackingTask({ task_id: err.data.task_id }).then(() => {
                  this.curStationIdChecked = true;
                  if (this.isWmsLoginUserAsDefaultPacker) {
                    this.addPacker();
                  } else {
                    this.$nextTick(() => {
                      (this.$refs['packerIdInput'] as HTMLInputElement).focus();
                    });
                  }
                });
              }
            }
          }
          if (err.retcode === -21852) {
            // station 被禁用
            const title = this.$i18n('Notice');
            await (this as any).$alert(err.message, title, {
              showClose: false,
            });
            setTimeout(() => {
              (this.$refs['statonIdInput'] as HTMLInputElement).select();
            }, 200);
          }
        } catch (e) {
          e;
        }
      });
  }
}
</script>

<style lang="scss" scoped>
$border: 1px solid #ecf0f4;

.m-packer-scan {
  display: flex;
  width: 100%;
  height: 100%;
  flex-direction: column;
}

.m-input-panel {
  padding: 24px;
  background-color: #ffffff;

  span {
    padding-right: 16px;
  }

  label {
    display: inline-block;
    padding-right: 16px;
    width: 120px;
    text-align: right;
  }
}

.m-main-container {
  overflow: scroll;
  margin-top: 8px;
  border: $border;
  padding: 16px 24px;
  padding-bottom: 72px;
  width: 100%;
  background-color: #ffffff;
  flex-grow: 1;

  .m-table-panel {
    position: relative;
    overflow: hidden;
    padding-bottom: 48px;
    min-height: 288px;
  }

  .u-packer-total {
    position: absolute;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 100;
    border: $border;
    border-top: none;
    border-radius: 0 0 4px 4px;
    padding-left: 16px;
    height: 48px;
    background: #ffffff;
    box-shadow: 0 1px 8px 0 rgba(0, 0, 0, 0.12);
    line-height: 48px;
  }
}

.m-btns-panel {
  position: absolute;
  right: 0;
  bottom: 0;
  left: 0;
  z-index: 1000;
  padding: 12px 24px;
  text-align: right;
  background-color: #ffffff;
  box-shadow: 0 1px 8px 0 rgba(0, 0, 0, 0.12);

  button {
    margin-left: 14px;
  }
}

::v-deep .ssc-table {
  overflow: scroll;
  border-bottom: none;
  max-height: 100%;
  border-bottom-left-radius: unset;
  border-bottom-right-radius: unset;
}
</style>



<template>
  <div class="m-packer-scan">
    <div class="m-input-panel">
      <div v-if="stationIdNeed" style="margin-bottom: 16px">
        <label>{{ $i18n('Station ID') }}</label>
        <s-input
          ref="statonIdInput"
          v-only-scan="{
            interval: 'PC.ManualInputPermission.StationID.Input',
            expression: 'curStationId',
          }"
          v-loading="stationIdInputLoading"
          :disabled="curStationIdChecked"
          v-model.trim="curStationId"
          @keyup.enter.native="stationIdScan"
          @input="changeToUpperCase"
        />
      </div>
      <div>
        <label>{{ $i18n('User /Staff ID') }}</label>
        <s-input
          ref="packerIdInput"
          v-only-scan="{
            interval: 'PC.ManualInputPermission.UserID&StaffID.Input',
            expression: 'curPackerId',
          }"
          :disabled="!curStationIdChecked"
          v-loading="inputLoading"
          v-model.trim="curPackerId"
          @keyup.enter.native="addPacker"
        />
      </div>
    </div>
    <div class="m-main-container" id="main-container">
      <div class="m-table-panel" :style="{ height: tablePanelHeight }">
        <s-table
          :data="packerList"
          :scroll="{
            y: packerList.length > 4 ? '100%' : '200px',
          }"
        >
          <s-table-column :label="$i18n('Packer ID')">
            <template v-slot="scope">
              <s-tooltip
                :content="String(scope.row.user_id || scope.row.staff_no)"
              >
                <span>{{ scope.row.user_id || scope.row.staff_no }}</span>
              </s-tooltip>
            </template>
          </s-table-column>
          <s-table-column
            prop="email"
            :label="$i18n('Packer Name')"
            :show-overflow-tooltip="true"
          ></s-table-column>
          <s-table-column
            :label="$i18n('Action')"
            v-slot="scope"
            :width="80"
            fixed="right"
          >
            <s-button type="text" @click="removePackerItem(scope.index)">
              {{ $i18n('Delete') }}
            </s-button>
          </s-table-column>
        </s-table>
        <div class="u-packer-total">
          {{ $i18n('Total:') + ' ' + packerList.length }}
        </div>
      </div>
    </div>
    <div class="m-btns-panel">
      <s-button :disabled="packerList.length == 0" @click="reset">
        {{ $i18n('Reset') }}
      </s-button>
      <s-button
        :disabled="packerList.length == 0 || !curStationIdChecked"
        type="primary"
        @click="confirm"
        v-loading="confirmLoading"
      >
        {{ $i18n('Confirm') }}
      </s-button>
    </div>
  </div>
</template>

<script lang="ts">
import { Vue, Component } from 'vue-property-decorator';
import {
  validatePackerUser,
  createPackerTask,
  checkStation,
  getStationSetting,
  bindStation,
  cancelPackingTask,
} from '@/api/sales-outbound/packing';
import { notificationSoundProcess } from '@/utils/notification-sound';
import { safeGet } from '@/utils/safeGet';
import { RECORD_PACKING_STATION_ID } from '../constant';
import { State } from 'vuex-class';

interface PackerConfig {
  staff_no: string;
  email: string;
  user_id: number;
}

@Component
export default class PackerScan extends Vue {
  @State permission: any;
  curPackerId = '';

  packerList: PackerConfig[] = [];

  packerSet: Set<string> = new Set();

  inputLoading = false;

  // 创建的 task ID
  createdTaskId = '';

  // 当前的 station id
  curStationId = '';

  // station 扫描 loading
  stationIdInputLoading = false;

  // 是否检查通过
  curStationIdChecked = false;

  // 是否需要扫描 station id
  stationIdNeed = true;

  // 表格高度
  tableHeight = 0;

  // 确认 loading
  confirmLoading = false;

  get tablePanelHeight() {
    const height = (this.packerList.length + 2) * 48;
    return height > this.tableHeight ? this.tableHeight + 'px' : height + 'px';
  }

  async mounted() {
    try {
      // 获取 station 设置
      const res = await getStationSetting();
      const list = safeGet(res, 'data.list');
      // 获取 packing 的 station 设置
      this.stationIdNeed = !!list.filter((item: any) => {
        return item.setting_key === RECORD_PACKING_STATION_ID;
      })[0]?.setting_enable;
      if (this.stationIdNeed) {
        this.curStationIdChecked = false;
        this.$nextTick(() => {
          (this.$refs['statonIdInput'] as HTMLInputElement).focus();
        });
      } else {
        this.curStationIdChecked = true;
        this.$nextTick(() => {
          (this.$refs['packerIdInput'] as HTMLInputElement).focus();
        });
      }
    } catch (e) {
      console.log(e);
      e;
    }
    const container = document.getElementById('main-container');
    this.tableHeight = Number(container?.clientHeight) - 88;
  }

  addPacker() {
    if (!this.curPackerId) {
      return;
    }
    this.inputLoading = true;
    validatePackerUser([this.curPackerId])
      .then((res: any) => {
        const { staff_no, email, user_id } = res.data.user_list[0];
        const newUser = JSON.stringify({
          staff_no: staff_no || null,
          email,
          user_id,
        });
        if (this.packerSet.has(newUser)) {
          this.packerSet.delete(newUser);
        }
        this.packerSet.add(newUser);
        this.packerList = Array.from(this.packerSet)
          .map((item: string) => {
            return JSON.parse(item);
          })
          .reverse();
        this.inputLoading = false;
        this.curPackerId = '';
      })
      .catch(async (err) => {
        // 判断是否存在任务
        if (err.retcode === -233407) {
          // 存在任务
          try {
            const { staff_no, email, user_id } = err.data.user_list[0];
            const newUser = JSON.stringify({
              staff_no: staff_no || null,
              email,
              user_id,
            });
            if (this.packerSet.has(newUser)) {
              // 已经添加过，就不提示直接置顶
              this.packerSet.delete(newUser);
              this.packerSet.add(newUser);
            } else {
              // 还没添加过，提示再添加
              await (this as any).$confirm(err.message, this.$i18n('Notice'));
              this.packerSet.add(newUser);
            }
            (this.$refs['packerIdInput'] as HTMLInputElement).focus();
            this.packerList = Array.from(this.packerSet)
              .map((item: string) => {
                return JSON.parse(item);
              })
              .reverse();
          } catch (e) {
            e;
          }
        }
        this.inputLoading = false;
        this.curPackerId = '';
      })
      .finally(() => {
        (this.$refs['packerIdInput'] as HTMLInputElement).focus();
        this.inputLoading = false;
        this.curPackerId = '';
      });
  }

  async reset() {
    try {
      await (this as any).$confirm('Reset packer List?', 'Notice');
      this.packerList = [];
      this.curPackerId = '';
      this.packerSet.clear();
      (this.$refs['packerIdInput'] as HTMLInputElement).focus();
    } catch (e) {
      console.log(e);
    }
  }

  async confirm() {
    const key = this.packerList.map((item) => {
      console.log(item, item.user_id);
      if (item.user_id === 0) {
        return item.staff_no + '';
      } else {
        return item.user_id + '';
      }
    });
    // 判断是否存在任务
    validatePackerUser(key as string[])
      .then(() => {
        // 校验通过，直接创建任务并绑定station
        this.createTaskAndBindStation();
      })
      .catch(async (err) => {
        if (err.retcode === -233407) {
          /**
           * 存在任务需要确认再创建
           * 这里存在的 task 任务可能是上一次绑定没成功的 task，需要处理
           */
          if (this.createdTaskId && err.message.indexOf(this.createdTaskId)) {
            /**
             * 存在的话就不需要提问了，说明上一次操作绑定 station 失败
             * 重新创建，并且带上 task id
             */
            this.createTaskAndBindStation();
          } else {
            try {
              /**
               * 存在任务，但是在其他 station
               * 提示用户是否要结束其他任务来创建新的 task
               */
              await (this as any).$confirm(err.message, this.$i18n('Notice'));
              this.createTaskAndBindStation();
            } catch (e) {
              e;
            }
          }
        }
      });
  }

  /**
   * 创建任务并绑定 station
   */
  createTaskAndBindStation() {
    this.confirmLoading = true;
    createPackerTask(this.packerList, this.createdTaskId || undefined)
      .then(async (res) => {
        const task_id = safeGet(res, 'data.task_id');
        const station_id = this.curStationId;
        this.createdTaskId = task_id;
        try {
          station_id && (await bindStation({ task_id, station_id }));
          // 绑定成功
          this.confirmLoading = false;
          notificationSoundProcess(
            'PC.Outbound.Sales Outbound.Packing.enter session success'
          ); //播放提示音
          this.$emit('packerConfirm', { task_id, station_id });
        } catch (bindErr) {
          /**
           * 绑定失败可能是两大种
           * 1、因为并发问题导致 station 状态为 using
           * 2、其他（网络问题）
           */
          // 因为并发问题导致 station 状态为 using
          if (bindErr.retcode === -21853) {
            // station using 状态不能用了，需要重新扫一个
            this.$message.error('Station is using, please try again.');
            this.curStationIdChecked = false;
            this.confirmLoading = false;
            this.$nextTick(() => {
              (this.$refs['statonIdInput'] as HTMLInputElement).select();
            });
          } else if (bindErr.retcode === -21852) {
            // station 被禁用
            const title = this.$i18n('Notice');
            await (this as any).$alert(bindErr.message, title, {
              showClose: false,
            });
            this.curStationIdChecked = false;
            this.confirmLoading = false;
            this.$nextTick(() => {
              (this.$refs['statonIdInput'] as HTMLInputElement).select();
            });
          } else {
            this.confirmLoading = false;
            try {
              // 递归去处理
              await (this as any).$confirm(
                'Bind Station error, please try again.',
                'Notice'
              );
              await this.createTaskAndBindStation();
            } catch (e) {
              e;
            }
          }
        }
      })
      .catch((err) => {
        err;
        this.confirmLoading = false;
      });
  }

  removePackerItem(index: number) {
    const newUser = JSON.stringify(this.packerList[index]);
    this.packerSet.delete(newUser);
    this.packerList.splice(index, 1);
  }

  changeToUpperCase() {
    this.curStationId = this.curStationId.toUpperCase();
  }

  // station 扫描
  async stationIdScan() {
    if (!this.curStationId) return;
    this.stationIdInputLoading = true;
    // 前端检测
    if (!/^PS\d{5}$/.test(this.curStationId)) {
      const title = this.$i18n('Notice');
      const msg = this.$i18n('Invalid Packing Station ID!');
      await (this as any).$alert(msg, title, { showClose: false });
      this.stationIdInputLoading = false;
      setTimeout(() => {
        (this.$refs['statonIdInput'] as HTMLInputElement).select();
      }, 200);
      return;
    }
    this.curStationIdChecked = false;
    // 检查 station 状态
    checkStation({ station_id: this.curStationId })
      .then(async (res: any) => {
        const task_id = safeGet(res, 'data.task_id');
        if (!task_id) {
          // 校验通过，并且不存在 task id，station = normal 状态
          this.curStationIdChecked = true;
          this.stationIdInputLoading = false;
          this.$nextTick(() => {
            (this.$refs['packerIdInput'] as HTMLInputElement).focus();
          });
        }
      })
      .catch(async (err: any) => {
        this.stationIdInputLoading = false;
        try {
          /**
           * 存在三种错误
           * 1、不存在
           * 2、被禁用：重新扫描
           *
           * 3、被占用 using 状态：是否进入 station 的任务
           */
          if (err.retcode === -21851) {
            // 不存在
            (this.$refs['statonIdInput'] as HTMLInputElement).select();
          }
          if (err.retcode === -21853) {
            // station: status = using，被占用
            if (err.data.task_id) {
              try {
                // 如果status = using，则弹出一个窗口，显示消息“此包装站正在进行会话。恢复会话？”。
                const msg = this.$i18n(
                  'There is an ongoing session at this packing station. Resume Session?'
                );
                const title = this.$i18n('Notice');
                await (this as any).$confirm(msg, title, {
                  showClose: false,
                  confirmButtonText: this.$i18n('resume'),
                  cancelButtonText: this.$i18n('start a new session'),
                  confirmButtonClass: 'resumeConfirm',
                });
                // 确认继续会话，光标跳至“ LM Tracking No”框
                this.$emit('packerConfirm', {
                  task_id: err.data.task_id,
                  station_id: this.curStationId,
                });
              } catch (e) {
                /**
                 * 单击“开始新会话”按钮pop_up消失，光标跳到“ WMS_User_ID /职员ID”框。
                 * 需要释放掉原来的 task 和 station
                 */
                // 接口释放操作
                cancelPackingTask({ task_id: err.data.task_id }).then(() => {
                  this.curStationIdChecked = true;
                  this.$nextTick(() => {
                    (this.$refs['packerIdInput'] as HTMLInputElement).focus();
                  });
                });
              }
            }
          }
          if (err.retcode === -21852) {
            // station 被禁用
            const title = this.$i18n('Notice');
            await (this as any).$alert(err.message, title, {
              showClose: false,
            });
            setTimeout(() => {
              (this.$refs['statonIdInput'] as HTMLInputElement).select();
            }, 200);
          }
        } catch (e) {
          e;
        }
      });
  }
}
</script>

<style lang="scss" scoped>
$border: 1px solid #ecf0f4;

.m-packer-scan {
  display: flex;
  width: 100%;
  height: 100%;
  flex-direction: column;
}

.m-input-panel {
  padding: 24px;
  background-color: #ffffff;

  span {
    padding-right: 16px;
  }

  label {
    display: inline-block;
    padding-right: 16px;
    width: 120px;
    text-align: right;
  }
}

.m-main-container {
  overflow: scroll;
  margin-top: 8px;
  border: $border;
  padding: 16px 24px;
  padding-bottom: 72px;
  width: 100%;
  background-color: #ffffff;
  flex-grow: 1;

  .m-table-panel {
    position: relative;
    overflow: hidden;
    padding-bottom: 48px;
    min-height: 288px;
  }

  .u-packer-total {
    position: absolute;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 100;
    border: $border;
    border-top: none;
    border-radius: 0 0 4px 4px;
    padding-left: 16px;
    height: 48px;
    background: #ffffff;
    box-shadow: 0 1px 8px 0 rgba(0, 0, 0, 0.12);
    line-height: 48px;
  }
}

.m-btns-panel {
  position: absolute;
  right: 0;
  bottom: 0;
  left: 0;
  z-index: 1000;
  padding: 12px 24px;
  text-align: right;
  background-color: #ffffff;
  box-shadow: 0 1px 8px 0 rgba(0, 0, 0, 0.12);

  button {
    margin-left: 14px;
  }
}

::v-deep .ssc-table {
  overflow: scroll;
  border-bottom: none;
  max-height: 100%;
  border-bottom-left-radius: unset;
  border-bottom-right-radius: unset;
}
</style>
